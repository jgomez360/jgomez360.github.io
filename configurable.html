<!DOCTYPE html>
<html>
  <head>
	<title>Configurable</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="js/jquery.mobile-1.4.5.min.css">
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
  </head>
  <body>
	<!-- Main Page -->
	<div data-role="page" id="main">
	  <div data-role="header" class="jqm-header">
		<h1>Select a workout</h1>
			<a data-parm="1" href="#workout-detail" class="ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-right">Add</a>
	  </div>
	  

	  <div data-role="content">

		
		
		<div class="ui-body ui-body-d ui-corner-all">
			<div data-role="controlgroup" id="my-controlgroup"><!-- items will be injected here --></div>
		</div>
		
		</div>
	</div><!-- /page -->
		
	
	<!-- Start of second page -->
	<div data-role="page" id="add-workout">
	
		<div data-role="header">
			<h1>Bar</h1>
		</div><!-- /header -->

		<div role="body" class="ui-content">
			<p>I'm the second in the source order so I'm hidden when the page loads. I'm just shown if a link that references my id is being clicked.</p>
			<p><a href="#main">Back to foo</a></p>
		</div><!-- /content -->

		<div data-role="footer">

		</div><!-- /footer -->
	</div><!-- /page -->

		<!-- Start of third page -->
	<div data-role="page" id="workout-detail">
		<div data-role="header">
			<h1 id="workout-title">Workout Title</h1>
		</div><!-- /header -->
		<div data-role="collapsibleset" data-content-theme="a" data-iconpos="right" id="exercises"></div>

		<div class="ui-body ui-body-b">
		  <fieldset class="ui-grid-a">
			  <div class="ui-block-a"><button type="submit" data-theme="a" id="b-submit">Select Workout</button></div>
<!--			  <div class="ui-block-b"><a href="#main"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></a></div>	-->
			  <div class="ui-block-b"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></div>
		  </fieldset>
		</div>
		
		<textarea style="white-space: pre-wrap;" id="json"></textarea>
		
	</div><!-- /page -->
	
	<script>
	
	var data = { 
	  "currentWorkoutId":0,
	  "workouts":[
	  {
		"id":0,
		"name":"Back & Biceps",
		"exercises": [
		{
		  "id":1,
		  "name":"Pull-Ups",
		  "restTime":120,
		  "reps": [ 10, 10, 10, 10 ],
		  "loads": [ 30, 30, 30, 30 ]
		},
		{
		  "id":2,
		  "name":"Under Hand Bent Over Rows",
		  "restTime":90,
		  "reps": [ 12, 10, 8, 8 ],
		  "loads": [ 20, 20, 20, 20 ]
		},
		{
		  "id":3,
		  "name":"Lawn Mowers",
		  "restTime":90,
		  "reps": [ 12, 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":4,
		  "name":"Back Extensions",
		  "restTime":90,
		  "reps": [ 12, 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":5,
		  "name":"Incline Bench Curls",
		  "restTime":120,
		  "reps": [ 12, 12, 12 ],
		  "loads": [ 60, 60, 65 ]
		},
		{
		  "id":6,
		  "name":"Preacher Bench Curls",
		  "restTime":90,
		  "reps": [ 10, 10, 10 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":7,
		  "name":"Hammer Rope Curls",
		  "restTime":90,
		  "reps": [ 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0 ]
		}
		]
	  },
	  {
		"id":1,
		"name":"Chest & Triceps",
		"exercises": [
		{
		  "id":9,
		  "name":"Bench Press",
		  "restTime":120,
		  "reps": [ 10, 8, 6, 4, 2, 2 ],
		  "loads": [ 135, 165, 195, 205, 235, 260 ]
		},
		{
		  "id":10,
		  "name":"Incline Dumbbell Fly w/ Close Press",
		  "restTime":90,
		  "reps": [ 10, 10, 10, 10 ],
		  "loads": [ 35, 35, 35, 35 ]
		},
		{
		  "id":11,
		  "name":"Single Arm Dumbbell Press",
		  "restTime":90,
		  "reps": [ 10, 10, 10, 10 ],
		  "loads": [ 60, 60, 60, 60 ]
		},
		{
		  "id":12,
		  "name":"Giant Tricep Set",
		  "restTime":90,
		  "reps": [ 10, 10, 10, 10 ],
		  "loads": [ 0, 0, 0, 0 ]
		}
		]
	  },
	  {
		"id":2,
		"name":"Legs, Shoulders & Abs",
		"exercises": [
		{
		  "id":14,
		  "name":"Squats",
		  "restTime":90,
		  "reps": [ 15, 12, 10, 8, 8 ],
		  "loads": [ 0, 0, 0, 0, 0 ]
		},
		{
		  "id":15,
		  "name":"Romanian Deadlifts",
		  "restTime":120,
		  "reps": [ 12, 12, 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0, 0 ]
		},
		{
		  "id":16,
		  "name":"Walking Lunges",
		  "restTime":90,
		  "reps": [ 12, 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":17,
		  "name":"Overhead Press",
		  "restTime":90,
		  "reps": [ 15, 12, 10, 8, 8 ],
		  "loads": [ 0, 0, 0, 0, 0 ]
		},
		{
		  "id":18,
		  "name":"Side Lateral Raise",
		  "restTime":90,
		  "reps": [ 12, 12, 12, 12 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":20,
		  "name":"Standing Calf Raises",
		  "restTime":90,
		  "reps": [ 15, 15, 15, 15 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":21,
		  "name":"Hanging Leg Raise",
		  "restTime":90,
		  "reps": [ 20, 20, 20 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":22,
		  "name":"Cable Twists",
		  "restTime":90,
		  "reps": [ 15, 15, 15 ],
		  "loads": [ 0, 0, 0, 0 ]
		},
		{
		  "id":23,
		  "name":"Ab Machine Crunch",
		  "restTime":90,
		  "reps": [ 10, 10, 10, 10 ],
		  "loads": [ 0, 0, 0, 0 ]
		}
		]
	  },
	  ]
	}
		

	$(document).on('pageinit', '#main', function() {

		var action = function(e) {
			data.currentWorkoutId = $(e.target).attr( "data-parm" );
		};
		
		for (var i in data.workouts) {
			var $el = $( "<a data-parm='" + data.workouts[i].id + "' href='#workout-detail' class='ui-btn ui-corner-all ui-icon-carat-r ui-btn-icon-right'>" + data.workouts[i].name + "</a>" ).bind( "click", action );
			$( "#my-controlgroup" ).controlgroup( "container" ).append( $el );
			$el.buttonMarkup();
		}
		
		$( "#my-controlgroup" ).controlgroup( "refresh" );
	});
			
	$(document).on('pagebeforeshow', '#workout-detail', function(){
		// Get current workout
		// Change to get workout by key
		var w = data.workouts[data.currentWorkoutId];
		
		// Set workout name
		var element = document.getElementById("workout-title").innerHTML = w.name;

		var container = document.getElementById("exercises");
		while (container.hasChildNodes()) {
			container.removeChild(container.lastChild);
		}
		
		var nav0 = document.createElement("div");
			nav0.setAttribute('class', 'ui-grid-a');
			
		var renameWorkout = document.createElement("div");
		renameWorkout.setAttribute('class', 'ui-block-a');
		renameWorkout.setAttribute('id', data.currentWorkoutId);
		//renameWorkout.setAttribute('onclick', 'renameWorkout(' + data.currentWorkoutId + ')');
		renameWorkout.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Rename</a>";
		nav0.appendChild(renameWorkout);
		
		var addExer = document.createElement("div");
		addExer.setAttribute('class', 'ui-block-b');
		addExer.setAttribute('id', data.currentWorkoutId);
		//addExer.setAttribute('onclick', 'addExer(' + data.currentWorkoutId + ')');
		addExer.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Add Exercise</a>";
		nav0.appendChild(addExer);

		container.appendChild(nav0);
		
				
		for (i=0; i<w.exercises.length; i++){
			var e = document.createElement("div");
			e.setAttribute('class', 'exercise');
			e.setAttribute('id', data.currentWorkoutId + 'eID' + i);
			e.setAttribute('data-role', 'collapsible');
			
			var eName = document.createElement("h3");
			eName.setAttribute('class', 'eName');
			eName.setAttribute('id', data.currentWorkoutId + 'eName' + i);
			eName.innerHTML = w.exercises[i].name;
			e.appendChild(eName);
			
			var navbar = document.createElement("div");
			navbar.setAttribute('data-role', 'navbar');
			navbar.setAttribute("align", "center");
			
			var nav1 = document.createElement("div");
			nav1.setAttribute('class', 'ui-grid-a');
			
			var renameExer = document.createElement("div");
			renameExer.setAttribute('class', 'ui-block-a');
			renameExer.setAttribute('id', data.currentWorkoutId + 'eRename' + i);
			renameExer.setAttribute('onclick', 'renameExer(' + data.currentWorkoutId + ',' + i + ')');
			renameExer.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Rename</a>";
			nav1.appendChild(renameExer);
			
			var removeExer = document.createElement("div");
			removeExer.setAttribute('class', 'ui-block-b');
			removeExer.setAttribute('id', data.currentWorkoutId + 'eRemove' + i);
			removeExer.setAttribute('onclick', 'removeExer(' + data.currentWorkoutId + ',' + i + ')');
			removeExer.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Remove</a>";
			nav1.appendChild(removeExer);

			navbar.appendChild(nav1);
			
			var nav2 = document.createElement("div");
			nav2.setAttribute('class', 'ui-grid-a');
			
			var addSet = document.createElement("div");
			addSet.setAttribute('class', 'ui-block-a');
			addSet.setAttribute('onclick', 'addSet(' + data.currentWorkoutId + ',' + i + ')');
			addSet.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Add Set</a>";
			nav2.appendChild(addSet);
			
			var removeSet = document.createElement("div");
			removeSet.setAttribute('class', 'ui-block-b');
			removeSet.setAttribute('onclick', 'removeSet(' + data.currentWorkoutId + ',' + i + ')');
			removeSet.innerHTML = "<a href='#' class='ui-btn ui-corner-all ui-shadow'>Remove Set</a>";
			nav2.appendChild(removeSet);
			
			navbar.appendChild(nav2);
			

			
			e.appendChild(navbar);
			
			var eStats = document.createElement("div");
			eStats.setAttribute('class', 'eStats');
			eStats.setAttribute('id', data.currentWorkoutId + 'eStats' + i);
						
			
			
			var restTime = document.createElement("div");
			restTime.setAttribute('class', 'ui-field-contain');
			restTime.setAttribute("align", "center");
			restTime.innerHTML = "Rest Time: <input id='restTime' class='restTime' type='tel' maxlength='3' size='3' value='" + w.exercises[i].restTime + "'> seconds";
			eStats.appendChild(restTime);
			
			for (j=0; j<w.exercises[i].reps.length; j++){
				var set = document.createElement("div");
				
				set.innerHTML += "Set " + (parseInt(j)+1) + " - ";
				set.innerHTML += "Reps:<input id='r" + j + "' class='rep' type='tel' maxlength='2' size='2' value='" + w.exercises[i].reps[j] + "'> ";
				set.innerHTML += "Load:<input id='l" + j + "' class='load' type='tel' maxlength='3' size='3' value='" + w.exercises[i].loads[j] + "'>";
		
				eStats.appendChild(set);			
			}
			
			e.appendChild(eStats);

			//document.getElementById("json").innerHTML += e.innerHTML + " ";
			
			container.appendChild(e);
			
			$('div[data-role=collapsible]').collapsible();
		}
	});
	 
	function addSet(wID, eID) {
		var eStatsID = wID + "eStats" + eID;
		var eStats = document.getElementById(eStatsID);
		
//		document.getElementById("json").innerHTML += document.getElementById(eStatsID).getElementsByTagName("div").length + " df";
		
		var setCount = document.getElementById(eStatsID).getElementsByTagName("div").length;
	
		var set = document.createElement("div");
		
		//set.innerHTML = "<a href='#' class='ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-notext ui-btn-inline'>Delete Rep</a>"
		set.innerHTML += "Set " + setCount + " - ";
		set.innerHTML += "Reps:<input id='r" + setCount + "' class='rep' type='tel' maxlength='2' size='2' value='0'> ";
		set.innerHTML += "Load:<input id='l" + setCount + "' class='load' type='tel' maxlength='3' size='3' value='0'>";

		eStats.appendChild(set);
	}

	function removeSet(wID, eID) {
		var eStatsID = wID + "eStats" + eID;
		var eStats = document.getElementById(eStatsID);
		
		if (eStats.childNodes.length > 2) {
			eStats.removeChild(eStats.lastChild);
		}
	}

	function renameExer(wID, eID) {
		
		var wName = prompt("Enter new exercise name", "");
		
		if (wName != null) {
			var eNameID = wID + "eName" + eID;
		//	alert(document.getElementById(eNameID).getElementsByTagName("a")[0].innerHTML);
			
			var eName = document.getElementById(eNameID).getElementsByTagName("a")[0].innerHTML = wName;
		
		
			$('div[data-role=collapsible]').collapsible();
		}
	}
	
	function removeExer(wID, eID) {
		
		var eNameID = wID + "eID" + eID;
//		alert(document.getElementById(eNameID).innerHTML);
		
		var eID = document.getElementById(eNameID);
		eID.parentNode.removeChild(eID);
		
	}
	
	function saveOptions() {
		// Build workout array
		var result = { "id":0,
			"name":"tempt name",
			"exercises": []
		}
		
		result.name = document.getElementById("workout-title").innerText;
		var exercises = document.getElementsByClassName("exercise");
					
		for (i=0; i<exercises.length; i++){
			var eStats = exercises[i].getElementsByClassName("eStats");

			result.exercises.push({	id : i, name : exercises[i].getElementsByClassName("eName")[0].innerText.slice(0,exercises[i].getElementsByClassName("eName")[0].innerText.indexOf(" click to")), restTime : parseInt(eStats[0].getElementsByClassName("restTime")[0].value), reps : [], loads : []});
			
			for (j=0; j<eStats[0].getElementsByClassName("rep").length; j++){
				result.exercises[i].reps[j] = parseInt(eStats[0].getElementsByClassName("rep")[j].value);
				result.exercises[i].loads[j] = parseInt(eStats[0].getElementsByClassName("load")[j].value);
						
			}
		}
		
		return result;
	}

	$().ready(function() {
		$("#b-cancel").click(function() {
			console.log("Cancel");
			//saveOptions();
			//document.location = "pebblejs://close";
							
			//document.getElementById("json").innerHTML = JSON.stringify(data.workouts[data.currentWorkoutId]);
			//document.getElementById("json").innerHTML = JSON.stringify(saveOptions());
			
			document.location = "#main";
		});

		$("#b-submit").click(function() {
			console.log("Submit");

			var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(saveOptions()));
			console.log("Warping to: " + location);
			console.log(location);
			document.location = location;
		});

	  });
	  
	function getObjects(obj, key, val) {
		var objects = [];
		for (var i in obj) {
			if (!obj.hasOwnProperty(i)) continue;
			if (typeof obj[i] == 'object') {
				objects = objects.concat(getObjects(obj[i], key, val));
			} else if (i == key && obj[key] == val) {
				objects.push(obj);
			}
		}
		return objects;
	}
	</script>
  </body>
</html>
